<html>

<head>
  <title>Simple Youtube Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="index.css">
</head>

<body>
  <div class="container">
    <div class="video-wrapper">
      <div id="player"></div>
    </div>
    <div class="video-control-wrapper">
      <div class="url-load-wrapper">
        <input id="videoUrl" type="url" value="https://www.youtube.com/watch?v=BYJzwK4sxRg" />
        <button id="loadUrlBtn">Load</button>
      </div>
      <div class="play-speed-rate-control-wrapper">
        <div class="play-speed-rate-control">
          <button id="speedDown">Speed -</button>
          <button id="speedUp">Speed +</button>
        </div>
        <input id="playSpeedRate" class="play-speed-rate text-align-center" type="number" value="1" min="0.25" max="2"
          step="0.05" />
      </div>
      <div class="ab-repeat-wrapper">
        <div class="ab-repeat-from-wrapper">
          <button id="playFromBtn">From Sec</button>
          <input id="abRepeatFrom" type="number" class="text-align-center" min="0" max="43200" value="0" />
          / <label id="duration1"></label>
        </div>
        <div class="ab-repeat-to-wrapper">
          <button id="playToBtn">To Sec</button>
          <input id="abRepeatTo" type="number" class="text-align-center" min="0" max="43200" value="0" />
          / <label id="duration2"></label>
        </div>
      </div>
      <div class="loop-wrapper">
        <label>Loop</label>
        <label class="switch">
          <input id="loopSwitch" type="checkbox" checked />
          <div class="slider round">
            <span class="on">ON</span><span class="off">OFF</span>
          </div>
        </label>
      </div>
    </div>
  </div>
  <script>
    const defaultVideoUrl = document.getElementById('videoUrl').value;

    bindingUIEventsToFunctions();

    function bindingUIEventsToFunctions() {
      document.getElementById('playSpeedRate').addEventListener("change", updatePlaySpeed);

      document.getElementById('speedDown').addEventListener("click", function () {
        document.getElementById('playSpeedRate').stepDown();
        document.getElementById('playSpeedRate').dispatchEvent(new Event("change"));
      });
      document.getElementById('speedUp').addEventListener("click", function () {
        document.getElementById('playSpeedRate').stepUp();
        document.getElementById('playSpeedRate').dispatchEvent(new Event("change"));
      });

      document.getElementById('loadUrlBtn').addEventListener("click", function () {
        if (player) {
          player.loadVideoById(urlToYoutubeVideoId(document.getElementById('videoUrl').value));
          document.getElementById('abRepeatFrom').value = 0;
          document.getElementById('abRepeatTo').value = 0;
        }
      });

      document.getElementById('playFromBtn').addEventListener("click", function () {
        if (player) {
          const currTime = player.getCurrentTime().toFixed(2);
          document.getElementById('abRepeatFrom').value = currTime;
          player.loadVideoById({
            videoId: urlToYoutubeVideoId(document.getElementById('videoUrl').value),
            startSeconds: currTime,
            endSeconds: document.getElementById('abRepeatTo').value
          })
        }
      });

      document.getElementById('playToBtn').addEventListener("click", function () {
        if (player) {
          const currTime = player.getCurrentTime().toFixed(2);
          document.getElementById('abRepeatTo').value = currTime;
          player.loadVideoById({
            videoId: urlToYoutubeVideoId(document.getElementById('videoUrl').value),
            startSeconds: document.getElementById('abRepeatFrom').value,
            endSeconds: currTime
          })
        }
      });
    }

    let tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";

    let firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    let player;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        videoId: urlToYoutubeVideoId(defaultVideoUrl),
        playerVars: {
          playsinline: '1'
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    }

    function onPlayerReady(event) {
      setInterval(updateDurationAndAbRepeatTo, 1000);
      updatePlaySpeed();
    }

    function updateDurationAndAbRepeatTo() {
      let duration = player.getDuration();
      if (duration) {
        duration = duration.toFixed(2);
        document.getElementById('duration1').textContent = duration;
        document.getElementById('duration2').textContent = duration;
        document.getElementById('abRepeatFrom').max = duration;
        document.getElementById('abRepeatTo').max = duration;
        const abRepeatFrom = parseFloat(document.getElementById('abRepeatFrom').value);
        const abRepeatTo = parseFloat(document.getElementById('abRepeatTo').value);
        if (abRepeatTo == 0 || abRepeatFrom >= abRepeatTo || abRepeatTo > duration) {
          document.getElementById('abRepeatTo').value = duration;
        }
      }
    }

    function onPlayerStateChange(event) {
      if (event.data == YT.PlayerState.ENDED && document.getElementById('loopSwitch').checked) {
        player.seekTo(document.getElementById('abRepeatFrom').value);
        player.playVideo();
      }
    }

    function urlToYoutubeVideoId(url) {
      let vid_regex = /(?:youtube(?:-nocookie)?\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/
      return url === "" ? "" : url.match(vid_regex)[1];
    }

    function updatePlaySpeed() {
      if (player) {
        let speedRate = parseFloat(document.getElementById('playSpeedRate').value);
        player.setPlaybackRate(speedRate);
      }
    }
  </script>
</body>

</html>