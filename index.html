<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-146129627-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-146129627-2');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="a web app that allows you to play the youtube video in a customised speed, play from time a to time b and loop the video">
  <meta name="keywords" content="youtube iframe api, speed, a-b repeat, repeat, loop">
  <meta name="author" content="This Wayne">
  <link rel="icon" type="image/png" href="TimeGem.png" sizes="16x16">
  <link rel="icon" type="image/png" href="TimeGem.png" sizes="32x32">
  <link rel="stylesheet" type="text/css" href="style.css">
  <title>Time Gem</title>
  <!-- production version, optimized for size and speed -->
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
</head>

<body>
  <div id="app" class="container">
    <header>
      <h1>
        <img src="TimeGem.png" class="title-icon" alt="title icon" />
        <span class="title-main">Time Gem</span>
      </h1>
      <p>
        <span class="title-sub">YouTube Player</span>
      </p>
    </header>
    <main>
      <section class="video-wrapper">
        <div id="player"></div>
      </section>
      <section class="video-control-wrapper">
        <div class="url-load-wrapper">
          <div class="video-url-wrapper">
            <input type="url" v-model="videoUrl" />
          </div>
          <div class="load-url-btn-wrapper">
            <button v-on:click="loadUrlClick">Load</button>
          </div>
        </div>
        <div class="play-speed-rate-control-wrapper">
          <div class="play-speed-rate-control">
            <button v-on:click="speedDownClick">Speed -</button>
            <button v-on:click="speedUpClick">Speed +</button>
          </div>
          <div class="play-speed-rate-wrapper">
            <input class="text-align-center" type="number" v-bind:min="minSpeed" v-bind:max="maxSpeed" step="0.05" v-model="playSpeedRate" />
          </div>

        </div>
        <div class="ab-repeat-wrapper">
          <div>
            <button v-on:click="playFromClick">From Now</button>
            <div>
              <input type="number" class="text-align-center" min="0" v-bind:max="duration" v-model="abRepeatFrom" v-on:input="setPlayerABRepeat" v-on:change="setPlayerABRepeat" />
              / <label>{{duration}}</label>
            </div>
          </div>
          <div>
            <button v-on:click="playToClick">To Now</button>
            <div>
              <input type="number" class="text-align-center" min="0" v-bind:max="duration" v-model="abRepeatTo" v-on:input="setPlayerABRepeat" v-on:change="setPlayerABRepeat" />
              / <label>{{duration}}</label>
            </div>
          </div>
        </div>
        <div class="loop-wrapper">
          <label>Loop: </label>
          <label class="switch">
            <input type="checkbox" v-model="isLoopOn" />
            <div class="slider round">
              <span class="on">ON</span><span class="off">OFF</span>
            </div>
          </label>
        </div>
      </section>
    </main>
  </div>
  <script>
    const app = new Vue(
      {
        el: '#app',
        data() {
          return {
            player: {},
            videoUrl: 'https://www.youtube.com/watch?v=nHlJODYBLKs',
            minSpeed: 0.25,
            maxSpeed: 2,
            playSpeedRate: 1,
            abRepeatFrom: 0,
            abRepeatTo: 0,
            duration: 0,
            isLoopOn: true,
          }
        },
        methods: {
          onYouTubeIframeAPIReady(event) {
            this.$data.player = new YT.Player('player', {
              videoId: this.urlToYoutubeVideoId(this.$data.videoUrl),
              playerVars: {
                playsinline: '1'
              },
              events: {
                'onReady': this.onPlayerReady,
                'onStateChange': this.onPlayerStateChange
              }
            });
          },
          onPlayerReady(event) {
            setInterval(this.updateDurationAndAbRepeatTo, 1000);
          },
          onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED && this.$data.isLoopOn) {
              this.$data.player.seekTo(this.$data.abRepeatFrom);
              this.$data.player.playVideo();
            }
          },
          loadUrlClick(event) {
            if (this.$data.player) {
              this.$data.player.loadVideoById(this.urlToYoutubeVideoId(this.$data.videoUrl));
            }
          },
          speedUpClick(event) {
            this.$data.playSpeedRate = (parseFloat(this.$data.playSpeedRate) + parseFloat(0.05)).toFixed(2);
          },
          speedDownClick(event) {
            this.$data.playSpeedRate = (parseFloat(this.$data.playSpeedRate) - parseFloat(0.05)).toFixed(2);
          },
          playFromClick(event) {
            if (this.$data.player) {
              this.$data.abRepeatFrom = this.$data.player.getCurrentTime().toFixed(1);
              this.setPlayerABRepeat();
            }
          },
          playToClick(event) {
            if (this.$data.player) {
              this.$data.abRepeatTo = this.$data.player.getCurrentTime().toFixed(1);
              this.setPlayerABRepeat();
            }
          },
          updateDurationAndAbRepeatTo() {
            let duration = this.$data.player.getDuration();
            if (duration) {
              this.$data.duration = duration.toFixed(1);

              const abRepeatFrom = parseFloat(this.$data.abRepeatFrom);
              const abRepeatTo = parseFloat(this.$data.abRepeatTo);
              if (abRepeatFrom >= duration) {
                this.$data.abRepeatFrom = 0;
              }
              if (abRepeatTo == 0 || abRepeatFrom >= abRepeatTo || abRepeatTo > duration) {
                this.$data.abRepeatTo = duration;
              }
            }
          },
          setPlayerABRepeat() {
            if (this.$data.player) {
              this.$data.player.loadVideoById({
                videoId: this.urlToYoutubeVideoId(this.$data.videoUrl),
                startSeconds: this.$data.abRepeatFrom,
                endSeconds: this.$data.abRepeatTo
              })
            }
          },
          urlToYoutubeVideoId(url) {
            const vid_regex = /(?:youtube(?:-nocookie)?\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/
            return url === "" ? "" : url.match(vid_regex)[1];
          }
        },
        watch: {
          playSpeedRate(val) {
            let speedRate = this.$data.playSpeedRate;
            speedRate = Math.min(speedRate, this.$data.maxSpeed);
            speedRate = Math.max(speedRate, this.$data.minSpeed);
            this.$data.playSpeedRate = speedRate;

            if (this.$data.player) {
              this.$data.player.setPlaybackRate(speedRate);
            }
          },
        },
        mounted() {
          window.onYouTubeIframeAPIReady = this.onYouTubeIframeAPIReady;
          const tag = document.createElement('script');
          tag.src = "https://www.youtube.com/iframe_api";
          const firstScriptTag = document.getElementsByTagName('script')[0];
          firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        },
      }
    )
  </script>
</body>

</html>