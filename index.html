<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-146129627-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-146129627-2');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="a web app that allows you to play the youtube video in a customised speed, play from time a to time b and loop the video">
  <meta name="keywords" content="youtube iframe api, speed, a-b repeat, repeat, loop">
  <meta name="author" content="This Wayne">
  <link rel="icon" type="image/png" href="TimeGem.png" sizes="16x16">
  <link rel="icon" type="image/png" href="TimeGem.png" sizes="32x32">
  <link rel="stylesheet" type="text/css" href="style.css">
  <title>Time Gem</title>
</head>

<body>
  <div class="container">
    <header>
      <h1>
        <img src="TimeGem.png" class="title-icon" alt="title icon" />
        <span class="title-main">Time Gem</span>
      </h1>
      <p>
        <span class="title-sub">YouTube Player</span>
      </p>
    </header>
    <main>
      <section class="video-wrapper">
        <div id="player"></div>
      </section>
      <section class="video-control-wrapper">
        <div class="url-load-wrapper">
          <div class="video-url-wrapper">
            <input id="videoUrl" type="url" value="https://www.youtube.com/watch?v=nHlJODYBLKs" />
          </div>
          <div class="load-url-btn-wrapper">
            <button id="loadUrlBtn">Load</button>
          </div>
        </div>
        <div class="play-speed-rate-control-wrapper">
          <div class="play-speed-rate-control">
            <button id="speedDown">Speed -</button>
            <button id="speedUp">Speed +</button>
          </div>
          <div class="play-speed-rate-wrapper">
            <input id="playSpeedRate" class="text-align-center" type="number" value="1" min="0.25" max="2"
              step="0.05" />
          </div>

        </div>
        <div class="ab-repeat-wrapper">
          <div>
            <button id="playFromBtn">From Now</button>
            <div>
              <input id="abRepeatFrom" type="number" class="text-align-center" min="0" max="43200" value="0" />
              / <label id="duration1"></label>
            </div>
          </div>
          <div>
            <button id="playToBtn">To Now</button>
            <div>
              <input id="abRepeatTo" type="number" class="text-align-center" min="0" max="43200" value="0" />
              / <label id="duration2"></label>
            </div>
          </div>
        </div>
        <div class="loop-wrapper">
          <label>Loop: </label>
          <label class="switch">
            <input id="loopSwitch" type="checkbox" checked />
            <div class="slider round">
              <span class="on">ON</span><span class="off">OFF</span>
            </div>
          </label>
        </div>
      </section>
    </main>
  </div>
  <script>
    const defaultVideoUrl = getDomById('videoUrl').value;
    const maxSpeed = 2;
    const minSpeed = 0.25;
    bindingUIEventsToFunctions();

    function bindingUIEventsToFunctions() {
      getDomById('loadUrlBtn').addEventListener("click", function () {
        if (player) {
          player.loadVideoById(urlToYoutubeVideoId(getDomById('videoUrl').value));
          getDomById('abRepeatFrom').value = 0;
          getDomById('abRepeatTo').value = 0;
        }
      });

      getDomById('speedDown').addEventListener("click", function () {
        getDomById('playSpeedRate').stepDown();
        getDomById('playSpeedRate').dispatchEvent(new Event("change"));
      });
      getDomById('speedUp').addEventListener("click", function () {
        getDomById('playSpeedRate').stepUp();
        getDomById('playSpeedRate').dispatchEvent(new Event("change"));
      });

      getDomById('playSpeedRate').addEventListener("change", updatePlaySpeed);
      getDomById('playSpeedRate').addEventListener("input", updatePlaySpeed);

      getDomById('playFromBtn').addEventListener("click", function () {
        if (player) {
          getDomById('abRepeatFrom').value = player.getCurrentTime().toFixed(1);
        }
      });

      getDomById('abRepeatFrom').addEventListener("change", setPlayerABRepeat);
      getDomById('abRepeatFrom').addEventListener("input", setPlayerABRepeat);

      getDomById('playToBtn').addEventListener("click", function () {
        if (player) {
          getDomById('abRepeatTo').value = player.getCurrentTime().toFixed(1);
          setPlayerABRepeat();
        }
      });

      getDomById('abRepeatTo').addEventListener("change", setPlayerABRepeat);
      getDomById('abRepeatTo').addEventListener("input", setPlayerABRepeat);
    }

    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";

    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    let player;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        videoId: urlToYoutubeVideoId(defaultVideoUrl),
        playerVars: {
          playsinline: '1'
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    }

    function onPlayerReady(event) {
      setInterval(updateDurationAndAbRepeatTo, 1000);
      updatePlaySpeed();
    }

    function updateDurationAndAbRepeatTo() {
      let duration = player.getDuration();
      if (duration) {
        duration = duration.toFixed(1);
        getDomById('duration1').textContent = duration;
        getDomById('duration2').textContent = duration;
        getDomById('abRepeatFrom').max = duration;
        getDomById('abRepeatTo').max = duration;

        const abRepeatFrom = parseFloat(getDomById('abRepeatFrom').value);
        const abRepeatTo = parseFloat(getDomById('abRepeatTo').value);
        if (abRepeatFrom >= duration) {
          getDomById('abRepeatFrom').value = 0;
        }
        if (abRepeatTo == 0 || abRepeatFrom >= abRepeatTo || abRepeatTo > duration) {
          getDomById('abRepeatTo').value = duration;
        }
      }
    }

    function onPlayerStateChange(event) {
      if (event.data == YT.PlayerState.ENDED && getDomById('loopSwitch').checked) {
        player.seekTo(getDomById('abRepeatFrom').value);
        player.playVideo();
      }
    }

    function updatePlaySpeed() {
      let speedRate = parseFloat(getDomById('playSpeedRate').value);
      if (speedRate > maxSpeed) {
        speedRate = maxSpeed
        getDomById('playSpeedRate').value = maxSpeed;
      }
      else if (speedRate < minSpeed) {
        speedRate = minSpeed;
        getDomById('playSpeedRate').value = minSpeed;
      }
      if (player) {
        player.setPlaybackRate(speedRate);
      }
    }

    function setPlayerABRepeat() {
      if (player) {
        player.loadVideoById({
          videoId: urlToYoutubeVideoId(getDomById('videoUrl').value),
          startSeconds: getDomById('abRepeatFrom').value,
          endSeconds: getDomById('abRepeatTo').value
        })
      }
    }

    function urlToYoutubeVideoId(url) {
      const vid_regex = /(?:youtube(?:-nocookie)?\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/
      return url === "" ? "" : url.match(vid_regex)[1];
    }

    function getDomById(id) { return document.getElementById(id); }
  </script>
</body>

</html>